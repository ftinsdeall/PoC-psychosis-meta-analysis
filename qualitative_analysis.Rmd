---
title: "qualitative_analysis"
author: "Francesca Tinsdeall"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(readr)
library(tidyverse)
library(dplyr)
library(purrr)
library(stringr)
library(janitor)
library(ggplot2)
library(meta)
library(metafor)
library(dmetar)
library(gridExtra)
library(reshape2)
library(robvis)
library(forcats)
library(plyr)

```

# Read in correct data 

```{r}
SMD.g <- read.csv('meta.csv')
```


# Risk of Bias assessment 

## Get n of studies falling into low, high or unclear RoB categories for each Risk of Bias assessment question

```{r - rob numbers}

rob <- SMD.g %>% select(study_id_str, ro_b_assessment_blinding_of_animal_carers_handlers, ro_b_assessment_a_priori_power_calculations, ro_b_assessment_blinding_of_outcome_assessors, ro_b_assessment_allocation_concealment, ro_b_assessment_random_housing, ro_b_assessment_baseline_characteristics, ro_b_assessment_incomplete_outcome_data, ro_b_assessment_random_outcome_assessment, ro_b_assessment_unit_of_analysis_error, ro_b_assessment_presence_of_sequence_generation, ro_b_assessment_conflict_of_interest) %>% 
  distinct() %>% 
  select(-study_id_str)

rob.count <- apply(rob, 2 , table)
rob.count
```

### Results 
Blinding of animal handlers: High = 1, Low = 2, Unclear = 45
Blinding of outcome assessors: High = 1, Low = 8, Unclear = 39
baseline characteristics: High = 1, Low = 2, Unclear = 45

A priori power calculations: High = 0, Low = 1, Unclear = 47
Unit of analysis error: High = 26, Low = 21, Unclear = 1
Incomplete outcome data: High = 12, Low = 21, Unclear = 15

Presence of baseline characteristics: High = 0, Low = 20, Unclear = 28
Baseline characteristics: High = 0, Low = 6, Unclear = 42
Random housing: High = 1, Low = 1, Unclear = 46
Random outcome assessment: High = 0, Low = 13, Unclear = 35

Conflict of interest statement: High = 3, Low = 31, Unclear = 14

## Make % studies plot for RoB assessment 
```{r - rob plot}

rob$rob_category <- row.names(rob)
rob_plot <- melt(rob, id.vars = "rob_category") %>% 
  mutate(Risk = value) %>% 
  select(-value)
  
rob_plot$variable <- fct_recode(rob_plot$variable, 
                       "Blinding of animal handlers/carers" = "ro_b_assessment_blinding_of_animal_carers_handlers", 
                       'A priori power calculations' = 'ro_b_assessment_a_priori_power_calculations', 
             "Random sequence generation" = "ro_b_assessment_presence_of_sequence_generation",
             "Allocation concealement" = 'ro_b_assessment_allocation_concealment', 
             "Blinding of outcome assessors" = 'ro_b_assessment_blinding_of_outcome_assessors', 
             "Random housing" = "ro_b_assessment_random_housing", 
             "Baseline characteristics" = "ro_b_assessment_baseline_characteristics", 
             "Random outcome assessment" = "ro_b_assessment_random_outcome_assessment", 
             "Incomplete outcome data" =  "ro_b_assessment_incomplete_outcome_data", 
             "Unit of analysis error" = 'ro_b_assessment_unit_of_analysis_error', 
             "Conflict of interest" = 'ro_b_assessment_conflict_of_interest')

rob_plot$Risk <- fct_recode(rob_plot$Risk, 
                            "High RoB" = 'high RoB', 
                            "Low RoB" = 'low RoB',
                            "Unclear RoB" = 'unclear RoB')

rob_plot$Risk <- fct_relevel(rob_plot$Risk, 'Unclear RoB', 'Low RoB', 'High RoB')

rob_plot %>% 
  ggplot(aes(x = variable, fill = Risk)) +
  geom_bar(aes(y = (after_stat(count)/sum(after_stat(count)))*1000)) +
  legend_bottom() +
  coord_flip() + 
  labs(title = "Risk of Bias (RoB) assessment of studies meeting inclusion criteria", x = 'Risk of Bias Assessment Category', y = '% of publications') +
  theme(plot.title = element_text(size=14, face="bold")) +
  scale_fill_manual(values = c('grey', 'darkgreen', 'red'))

```

# Reporting quality of studies over time 

## 1. baseline characteristics 

```{r - baseline characteristics}

random_sequence_generation <- SMD.g %>% 
  select(ro_b_assessment_presence_of_sequence_generation, year) %>% 
  mutate(random_sequence_generation = as.factor(ro_b_assessment_presence_of_sequence_generation)) 

random_sequence_generation$random_sequence_generation <- fct_recode(random_sequence_generation$random_sequence_generation, 
                                                            'Unclear RoB' = 'unclear RoB',
                                                            "High RoB" = 'high RoB', 
                                                            "Low RoB" = 'low RoB')

random_sequence_generation$random_sequence_generation <- fct_relevel(random_sequence_generation$random_sequence_generation, 'Unclear RoB', 'Low RoB', 'High RoB')

rsg <-  random_sequence_generation %>% 
  ggplot(aes(x = year, fill = random_sequence_generation)) +
  geom_bar() +
  legend_bottom() +
  labs(title = 'baseline characteristics reporting over time', x = 'Year of publication', y = 'No. of publications') +
  scale_fill_manual(values = c('grey', 'darkgreen'))

```

## 2. Allocation concealment 

```{r - allocation concealment}

allocation_concealment <- SMD.g %>% 
  select(ro_b_assessment_allocation_concealment, year) %>% 
  mutate(allocation_concealment = as.factor(ro_b_assessment_allocation_concealment)) 

allocation_concealment$allocation_concealment <- fct_recode(allocation_concealment$allocation_concealment, 
                                                            'Unclear RoB' = 'unclear RoB',
                                                            "High RoB" = 'high RoB', 
                                                            "Low RoB" = 'low RoB')

allocation_concealment$allocation_concealment <- fct_relevel(allocation_concealment$allocation_concealment, 'Unclear RoB', 'Low RoB', 'High RoB')

ac <- allocation_concealment %>% 
  ggplot(aes(x = year, fill = allocation_concealment)) +
  geom_bar() +
  legend_bottom() +
  labs(title = 'Allocation concealment reporting over time', x = 'Year of publication', y = 'No. of publications') +
  scale_fill_manual(values = c('grey', 'darkgreen', 'red'))

```

Failure to perform baseline characteristics shown by Hirst 2014 paper to inflate effect sizes (although biased towards stroke research, but they did perform subgroup analysis to check that findings from stroke studies did not differ signifcantly from non-stroke studies)

## 3. Baseline characteristics 

```{r - baseline characteristics}

baseline_characteristics <- SMD.g %>% 
  select(ro_b_assessment_baseline_characteristics, year) %>% 
  mutate(baseline_characteristics = as.factor(ro_b_assessment_baseline_characteristics)) 

baseline_characteristics$baseline_characteristics <- fct_recode(baseline_characteristics$baseline_characteristics, 
                                                            'Unclear RoB' = 'unclear RoB',
                                                            "High RoB" = 'high RoB', 
                                                            "Low RoB" = 'low RoB')

baseline_characteristics$baseline_characteristics <- fct_relevel(baseline_characteristics$baseline_characteristics, 'Unclear RoB', 'Low RoB', 'High RoB')

bc <- baseline_characteristics %>% 
  ggplot(aes(x = year, fill = baseline_characteristics)) +
  geom_bar() +
  legend_bottom() +
  labs(title = 'Baseline characteristics reporting over time', x = 'Year of publication', y = 'No. of publications') +
  scale_fill_manual(values = c('grey', 'darkgreen'))

```

```{r - view plots together }
rsg + bc + ac
```


## 4. Blinding of animal carers/handlers

```{r - blinding animal carers}

blinding_handlers <- SMD.g %>% 
  select(ro_b_assessment_blinding_of_animal_carers_handlers, year) %>% 
  mutate(blinding_handlers = as.factor(ro_b_assessment_blinding_of_animal_carers_handlers)) 

blinding_handlers$blinding_handlers <- fct_recode(blinding_handlers$blinding_handlers, 
                                                            'Unclear RoB' = 'unclear RoB',
                                                            "High RoB" = 'high RoB', 
                                                            "Low RoB" = 'low RoB')

blinding_handlers$blinding_handlers <- fct_relevel(blinding_handlers$blinding_handlers, 'Unclear RoB', 'Low RoB', 'High RoB')

bh <- blinding_handlers %>% 
  ggplot(aes(x = year, fill = blinding_handlers)) +
  geom_bar() +
  legend_bottom() +
  labs(title = 'Blinding of animal handlers reporting over time', x = 'Year of publication', y = 'No. of publications') +
  scale_fill_manual(values = c('grey', 'darkgreen', 'red'))

```

## 5. Random housing 

```{r - random housing}

random_housing <- SMD.g %>% 
  select(ro_b_assessment_random_housing, year) %>% 
  mutate(random_housing = as.factor(ro_b_assessment_random_housing)) 

random_housing$random_housing <- fct_recode(random_housing$random_housing, 
                                                            'Unclear RoB' = 'unclear RoB',
                                                            "High RoB" = 'high RoB', 
                                                            "Low RoB" = 'low RoB')

random_housing$random_housing <- fct_relevel(random_housing$random_housing, 'Unclear RoB', 'Low RoB', 'High RoB')

rh <- random_housing %>% 
  ggplot(aes(x = year, fill = random_housing)) +
  geom_bar() +
  legend_bottom() +
  labs(title = 'Random housing of animals reporting over time', x = 'Year of publication', y = 'No. of publications') +
  scale_fill_manual(values = c('grey', 'darkgreen', 'red'))

```

## 6. Random outcome assessment 

```{r - random outcome assessment}

random_outcome <- SMD.g %>% 
  select(ro_b_assessment_random_outcome_assessment, year) %>% 
  mutate(random_outcome = as.factor(ro_b_assessment_random_outcome_assessment)) 

random_outcome$random_outcome <- fct_recode(random_outcome$random_outcome, 
                                                            'Unclear RoB' = 'unclear RoB',
                                                            "High RoB" = 'high RoB', 
                                                            "Low RoB" = 'low RoB')

random_outcome$random_outcome <- fct_relevel(random_outcome$random_outcome, 'Unclear RoB', 'Low RoB', 'High RoB')

ro <- random_outcome %>% 
  ggplot(aes(x = year, fill = random_outcome)) +
  geom_bar() +
  legend_bottom() +
  labs(title = 'Random outcome assessment reporting over time', x = 'Year of publication', y = 'No. of publications') +
  scale_fill_manual(values = c('grey', 'darkgreen', 'red'))

```


## 7. Blinding of outcome assessors 

```{r - blinding outcome assessors}

blind_outcome <- SMD.g %>% 
  select(ro_b_assessment_blinding_of_outcome_assessors, year) %>% 
  mutate(blind_outcome = as.factor(ro_b_assessment_blinding_of_outcome_assessors)) 

blind_outcome$blind_outcome <- fct_recode(blind_outcome$blind_outcome, 
                                                            'Unclear RoB' = 'unclear RoB',
                                                            "High RoB" = 'high RoB', 
                                                            "Low RoB" = 'low RoB')

blind_outcome$blind_outcome <- fct_relevel(blind_outcome$blind_outcome, 'Unclear RoB', 'Low RoB', 'High RoB')

bo <- blind_outcome %>% 
  ggplot(aes(x = year, fill = blind_outcome)) +
  geom_bar() +
  legend_bottom() +
  labs(title = 'Blinded outcome assessment reporting over time', x = 'Year of publication', y = 'No. of publications') +
  scale_fill_manual(values = c('grey', 'darkgreen', 'red'))

```

## 8. Incomplete outcome data 

```{r - incomplete outcome data}

iod <- SMD.g %>% 
  select(ro_b_assessment_incomplete_outcome_data, year) %>% 
  mutate(iod = as.factor(ro_b_assessment_incomplete_outcome_data)) 

iod$iod <- fct_recode(iod$iod, 
                                                            'Unclear RoB' = 'unclear RoB',
                                                            "High RoB" = 'high RoB', 
                                                            "Low RoB" = 'low RoB')

iod$iod  <- fct_relevel(iod$iod , 'Unclear RoB', 'Low RoB', 'High RoB')

iodplot <- iod %>% 
  ggplot(aes(x = year, fill = iod)) +
  geom_bar() +
  legend_bottom() +
  labs(title = 'Incomplete outcome assessment over time', x = 'Year of publication', y = 'No. of publications') +
  scale_fill_manual(values = c('grey', 'darkgreen', 'red'))

```


## 9. Unit of analysis error 

```{r - unit of analysis error}

uoa <- SMD.g %>% 
  select(ro_b_assessment_unit_of_analysis_error, year) %>% 
  mutate(uoa = as.factor(ro_b_assessment_unit_of_analysis_error)) 

uoa$uoa <- fct_recode(uoa$uoa, 
                                                            'Unclear RoB' = 'unclear RoB',
                                                            "High RoB" = 'high RoB', 
                                                            "Low RoB" = 'low RoB')

uoa$uoa  <- fct_relevel(uoa$uoa , 'Unclear RoB', 'Low RoB', 'High RoB')

uoaplot <- uoa %>% 
  ggplot(aes(x = year, fill = uoa)) +
  geom_bar() +
  legend_bottom() +
  labs(title = 'Unit of analysis errors over time', x = 'Year of publication', y = 'No. of publications') +
  scale_fill_manual(values = c('grey', 'darkgreen', 'red'))

```

## 10. A priori power calculations 

```{r - power calculatinos}

power_calc <- SMD.g %>% 
  select(ro_b_assessment_a_priori_power_calculations, year) %>% 
  mutate(power_calc = as.factor(ro_b_assessment_a_priori_power_calculations)) 

power_calc$power_calc <- fct_recode(power_calc$power_calc, 
                                                            'Unclear RoB' = 'unclear RoB',
                                                            "High RoB" = 'high RoB', 
                                                            "Low RoB" = 'low RoB')

power_calc$power_calc  <- fct_relevel(power_calc$power_calc , 'Unclear RoB', 'Low RoB', 'High RoB')

pc <- power_calc %>% 
  ggplot(aes(x = year, fill = power_calc)) +
  geom_bar() +
  legend_bottom() +
  labs(title = 'A priori power calculation reporting over time', x = 'Year of publication', y = 'No. of publications') +
  scale_fill_manual(values = c('grey', 'darkgreen', 'red'))

```

## 11. Conflict of interest statement 

```{r - conflict of interest statement}
conflict_interest <- SMD.g %>% 
  select(ro_b_assessment_conflict_of_interest, year) %>% 
  mutate(conflict_interest = as.factor(ro_b_assessment_conflict_of_interest)) 

conflict_interest$conflict_interest <- fct_recode(conflict_interest$conflict_interest, 
                                                            'Unclear RoB' = 'unclear RoB',
                                                            "High RoB" = 'high RoB', 
                                                            "Low RoB" = 'low RoB')

conflict_interest$conflict_interest  <- fct_relevel(conflict_interest$conflict_interest , 'Unclear RoB', 'Low RoB', 'High RoB')

coi <- conflict_interest %>% 
  ggplot(aes(x = year, fill = conflict_interest)) +
  geom_bar() +
  legend_bottom() +
  labs(title = 'Conflict of interest reporting over time', x = 'Year of publication', y = 'No. of publications') +
  scale_fill_manual(values = c('grey', 'darkgreen', 'red'))
```


## Make aggregated RoB over time plots 

```{r - plot all blinding levels together}
ac + bh + bo
```

```{r - plot all randomisation criteria together}
rsg + rh + ro
```

```{r - reporting quality plots}
bc + iodplot + uoaplot + pc + coi
```



# How many studies used more than one methodology for induction of the disease state? 

```{r}
d.c <- SMD.g %>% select(study_id_str, disease_cohort_str) %>% distinct() %>% count(study_id_str) %>% rename('n_of_polyIC_methodologies' = 'n')
table(d.c$n_of_polyIC_methodologies)
```
31 studies only used 1 methodology for induction of psychosis disease state via polyI:C MIA model 
12 studies used 2 methodologies for induction of psychosis disease state via polyI:C MIA model 
3 studies used 3 methodologies for induction of psychosis disease state via polyI:C MIA model 
2 studies used 4 methodologies for induction of psychosis disease state via polyI:C MIA model 

# Is using females/mixed cohorts rather than males only increasing with time? 

```{r - sex of cohorts used in studies over time}
year <- SMD.g %>% 
  select(study_id_str, year)

sex_of_cohorts_study.year <- sex_of_cohorts_study1 %>% 
  left_join(sex_of_cohorts_study2) %>% 
  mutate(cohorts_in_study = case_when(n == '1' ~ paste(sex_of_animals), 
                                      n == '2' ~ 'male and female independent cohorts')) %>% 
  select(-n, -sex_of_animals) %>% 
  distinct()

sex.time <- sex_of_cohorts_study.year %>% 
  left_join(year) %>% 
  distinct()

sex.time$cohorts_in_study <- as.factor(sex.time$cohorts_in_study)
sex.time$cohorts_in_study <- fct_relevel(sex.time$cohorts_in_study, 'mixed ', 'male and female independent cohorts', 'female ', 'male')

sex.time %>% 
  ggplot(aes(x = year, fill = cohorts_in_study)) +
  geom_bar() +
  legend_bottom() +
  labs(title = 'Sex of cohorts in studies over time', x = 'Year of publication', y = 'No. of publications') +
  scale_fill_manual(values = c('orange', 'gold1', 'deeppink', 'deepskyblue1'))


```


# Getting info for potential moderator variables 
## Sex of animals 

```{r - sex of animals contributing to effect sizes }
sex_of_cohorts_effect <- SMD.g %>% 
  select(effect_id, sex_of_animals) %>% 
  group_by(sex_of_animals) %>% 
  tally()

sex_of_cohorts_effect 
```

```{r - sex of animals within studies}
sex_of_cohorts_study1 <- SMD.g %>% 
  select(study_id_str, sex_of_animals) %>% 
  distinct() 
  
sex_of_cohorts_study2 <- sex_of_cohorts_study %>% 
  group_by(study_id_str) %>% 
  tally()

sex_of_cohorts_study <- sex_of_cohorts_study1 %>% 
  left_join(sex_of_cohorts_study2) %>% 
  mutate(cohorts_in_study = case_when(n == '1' ~ paste(sex_of_animals), 
                                      n == '2' ~ 'male and female independent cohorts')) %>% 
  select(-n) %>% 
  group_by(cohorts_in_study) %>% 
  tally()

```
### Results 
36 effect sizes were from female only cohorts
137 effect sizes were from male only cohorts 
74 effect sizes were from mixed sex cohorts 

5 studies used only female cohorts 
24 studies used only male cohorts 
12 studies assessed males and females in independent cohorts 
13 studies assessed males and females within the same cohort 

## Species of animals 

```{r - species of animals}
species_of_animals_effect <- SMD.g %>% 
  select(effect_id, species_of_animal) %>% 
  group_by(species_of_animal) %>% 
  tally()
```
### Results 
94 effect sizes from mice 
153 effect sizes from rats 


## Strain of animals
```{r - strain of animals}
strain_of_animals_effect <- SMD.g %>% 
  select(effect_id, strain) %>% 
  group_by(strain) %>% 
  tally()
```
### Results 
4 effect sizes from BALB/c
37 effect sizes from C57BL/6
20 effect sizes from C57BL/6J
29 effect sizes from C57BL/6N
4 effect sizes from ddY
41 effect sizes from long-evans 
75 effect sizes from sprague-dawley
31 effect sizes from wistar
6 effect sizes from wistar-hannover 


## PolyI:C Dose administered 
```{r - polyI:C dose administered}
polyIC_effect <- SMD.g %>% 
  select(effect_id, poly_I_C_daily_dose_mg_kg) %>% 
  group_by(poly_I_C_daily_dose_mg_kg) %>% 
  tally()
```
### Results 
3 effect sizes from NA
3 effect sizes from 0.75mg/kg
7 effect sizes from 12mg/kg
12 effect sizes from 2mg/kg
96 effect sizes from 4mg/kg
94 effect sizes from 5mg/kg
3 effect sizes from 8mg/kg
15 effect sizes from 10mg/kg
14 effects zies from 30mg/kg

## PolyI:C dose category administered 

```{r - polyI:C dose administered}
polyICcat_effect <- SMD.g %>% 
  select(effect_id, polyIC.dose.cat) %>% 
  group_by(polyIC.dose.cat) %>% 
  tally()
```


## Gestational day of polyI:C administration 
```{r - first GD administration}
GD_administration_effect <- SMD.g %>% 
  select(effect_id, GD_first_administration) %>% 
  group_by(GD_first_administration) %>% 
  tally()
```
### Results 
3 effect sizes from NA 
69 effect sizes from GD9
3 effect sizes from GD9.5
3 effect sizes from GD10
11 effect sizes from GD12
1 effect size from GD13
12 effect sizes from GD14
132 effect sizes from GD15
9 effect sizes from GD17
1 effect size from GD17.5
3 effects sizes from GD18

## Route of polyI:C administration 
```{r - administration route}
administration_route_effect <- SMD.g %>% 
  select(effect_id, administration_route) %>% 
  group_by(administration_route) %>% 
  tally()
```
### Results 
58 effect sizes from ip
183 effect sizes from iv 
6 effect sizes from sc


## Postnatal day of %PPI testing 
```{r - PND PPI testing}
PND_PPI_effect <- SMD.g %>% 
  select(effect_id, time) %>% 
  group_by(time) %>% 
  tally()
```
### Results
3 at NA 
5 at PND 30
4 at PND 34
14 at PND35
4 at PND36
6 at PND40
3 at PND 43
2 at PND50
6 at PND51
40 at PND56
22 at PND60
44 at PND70
1 at PND71
1 at PND72
1 at PND73
1 at PND74
2 at PND75
8 at PND76
2 at PND77
2 at PND78
1 at PND79
1 at PND80
1 at PND81
22 at PND84
16 at PND90
16 at PND91
1 at PND92
1 at PND93
1 at PND94
2 at PND97
2 at PND98
3 at PND100
3 at PND112
4 at PND119
2 at PND180

## Developmental stage at %PPI testing 
```{r - dev. stage PPI testing}
stage_PPI_effect <- SMD.g %>% 
  select(effect_id, developmental_stage_PPI) %>% 
  group_by(developmental_stage_PPI) %>% 
  tally()
```
### Results 
3 effect sizes at NA
27 effect sizes from juvenile offspring 
26 effect sizes from adoelscent offspring 
191 effect sizes from adult offspring 

# Qualititative description of variables not being invetigated as potential moderator variables 

## Acute or chronic polyI:C induction 

## Studies reporting %PPI across multiple pre-pulse intensities vs. for single pre-pulse intensities 

## Studies reporting %PPI across multiple pulse intensities vs. for single pulse intensities 

## Range of backgound intensities used 

## Pre-pulse durations 

## Pulse intensity above background used (will need to separate column to get pulses for averaged pulses)

## Pre-pulse intensity above background used (same as above)

## Interstimulus intervals used (will need to split column)



# Interventions (need to join a reduced version of the dataset with dataset that has all the interventions in)


# Proportion of studies reporting different effect size magnitude categories by potential moderator variables 

## Effect size magnitudes by sex 

```{r - sex}
sex.mag <- SMD.g %>% 
  select(effect_id, sex_of_animals, magnitude_effect_size) %>% 
  mutate(magnitude_effect_size = as.factor(magnitude_effect_size)) %>% 
  group_by(sex_of_animals, magnitude_effect_size) %>% 
  tally()

sex.mag.read <- sex.mag %>% pivot_wider(names_from = magnitude_effect_size, values_from = n)

sex.mag.2 <- sex.mag %>% 
  mutate(n.mag = n) %>% 
  select(-n) %>%  
  left_join(sex_of_cohorts_effect) %>% 
  mutate(percentage = (n.mag/n)*100)

sex.mag.2$magnitude_effect_size <- fct_relevel(sex.mag.2$magnitude_effect_size, 'large negative effect', 'moderate negative effect', 'small negative effect', 'no effect', 'small positive effect', 'moderate positive effect', 'large positive effect' )

ggplot(sex.mag) + 
  geom_col(aes(x = sex_of_animals, y = n, fill = magnitude_effect_size)) +
  scale_fill_manual(values = c('darkblue','blue', 'lightblue', 'white', 'pink', 'red', 'darkred')) 

ggplot(sex.mag) + 
  geom_col(aes(x = sex_of_animals, y = n, fill = sex_of_animals), position = 'dodge') +
  scale_fill_manual(values = c('deeppink2','deepskyblue', 'chocolate1'))  + facet_wrap(~magnitude_effect_size, ncol = 2) + coord_flip() 
                                
#this would be more informative if I converted n to percentages first                             
  
ggplot(sex.mag.2) + 
  geom_col(aes(x = magnitude_effect_size, y = percentage, fill = magnitude_effect_size), position = 'dodge') +
  scale_fill_manual(values = c('darkblue','blue', 'lightblue', 'white', 'pink', 'red', 'darkred'))  + facet_wrap(~sex_of_animals, ncol = 1) + coord_flip() 

ggplot(sex.mag.2) + 
  geom_col(aes(x = sex_of_animals, y = percentage, fill = sex_of_animals), position = 'dodge') +
  scale_fill_manual(values = c('deeppink2','deepskyblue', 'chocolate1'))  + facet_wrap(~magnitude_effect_size, ncol = 2) + 
  ylim(0, 100) +
  coord_flip() 


```

## Effect size magnitudes by species 

```{r - species}
species.mag <- SMD.g %>% 
  select(effect_id, species_of_animal, magnitude_effect_size) %>% 
  mutate(magnitude_effect_size = as.factor(magnitude_effect_size)) %>% 
  group_by(species_of_animal, magnitude_effect_size) %>% 
  tally()

species.mag.read <- species.mag %>% pivot_wider(names_from = magnitude_effect_size, values_from = n)

species.mag.2 <- species.mag %>% 
  mutate(n.mag = n) %>% 
  select(-n) %>% 
  left_join(species_of_animals_effect) %>% 
  mutate(percentage = (n.mag/n)*100)

species.mag.2$magnitude_effect_size <- fct_relevel(species.mag.2$magnitude_effect_size, 'large negative effect', 'moderate negative effect', 'small negative effect', 'no effect', 'small positive effect', 'moderate positive effect', 'large positive effect' )

ggplot(species.mag) + 
  geom_col(aes(x = species_of_animal, y = n, fill = magnitude_effect_size)) +
  scale_fill_manual(values = c('darkblue','blue', 'lightblue', 'white', 'pink', 'red', 'darkred')) 
                                
#this would be more informative if I converted n to percentages first                             

ggplot(species.mag.2) + 
  geom_col(aes(x = magnitude_effect_size, y = percentage, fill = magnitude_effect_size), position = 'dodge') +
  scale_fill_manual(values = c('darkblue','blue', 'lightblue', 'white', 'pink', 'red', 'darkred'))  + facet_wrap(~species_of_animal, ncol = 1) + coord_flip()
```

## Route of polyI:C administration

```{r - administration_route}
administration_route.mag <- SMD.g %>% 
  select(effect_id, administration_route, magnitude_effect_size) %>% 
  mutate(magnitude_effect_size = as.factor(magnitude_effect_size)) %>% 
  group_by(administration_route, magnitude_effect_size) %>% 
  tally()

administration_route.mag.read <- administration_route.mag %>% pivot_wider(names_from = magnitude_effect_size, values_from = n)

administration_route.mag.2 <- administration_route.mag %>% 
  mutate(n.mag = n) %>% 
  select(-n) %>% 
  left_join(administration_route_effect) %>% 
  mutate(percentage = (n.mag/n)*100)

administration_route.mag.2$magnitude_effect_size <- fct_relevel(administration_route.mag.2$magnitude_effect_size, 'large negative effect', 'moderate negative effect', 'small negative effect', 'no effect', 'small positive effect', 'moderate positive effect', 'large positive effect' )

ggplot(administration_route.mag) + 
  geom_col(aes(x = administration_route, y = n, fill = magnitude_effect_size)) +
  scale_fill_manual(values = c('darkblue','blue', 'lightblue', 'white', 'pink', 'red', 'darkred')) 
                                
#this would be more informative if I converted n to percentages first                             

ggplot(administration_route.mag.2) + 
  geom_col(aes(x = magnitude_effect_size, y = percentage, fill = magnitude_effect_size), position = 'dodge') +
  scale_fill_manual(values = c('darkblue','blue', 'lightblue', 'white', 'pink', 'red', 'darkred'))  + facet_wrap(~administration_route, ncol = 1) + coord_flip()
```

## PolyI:C dose category 

```{r - polyIC.dose.cat}
polyIC.dose.cat.mag <- SMD.g %>% 
  select(effect_id, polyIC.dose.cat, magnitude_effect_size) %>% 
  mutate(magnitude_effect_size = as.factor(magnitude_effect_size)) %>% 
  group_by(polyIC.dose.cat, magnitude_effect_size) %>% 
  tally()

polyIC.dose.cat.mag.read <- polyIC.dose.cat.mag %>% pivot_wider(names_from = magnitude_effect_size, values_from = n)

polyIC.dose.cat.mag.2 <- polyIC.dose.cat.mag %>% 
  mutate(n.mag = n) %>% 
  select(-n) %>% 
  left_join(polyICcat_effect) %>% 
  mutate(percentage = (n.mag/n)*100) %>% 
  drop_na()

polyIC.dose.cat.mag.2$magnitude_effect_size <- fct_relevel(polyIC.dose.cat.mag.2$magnitude_effect_size, 'large negative effect', 'moderate negative effect', 'small negative effect', 'no effect', 'small positive effect', 'moderate positive effect', 'large positive effect' )

ggplot(polyIC.dose.cat.mag) + 
  geom_col(aes(x = polyIC.dose.cat, y = n, fill = magnitude_effect_size)) +
  scale_fill_manual(values = c('darkblue','blue', 'lightblue', 'white', 'pink', 'red', 'darkred')) 
                                
#this would be more informative if I converted n to percentages first                             

ggplot(polyIC.dose.cat.mag.2) + 
  geom_col(aes(x = magnitude_effect_size, y = percentage, fill = magnitude_effect_size), position = 'dodge') +
  scale_fill_manual(values = c('darkblue','blue', 'lightblue', 'white', 'pink', 'red', 'darkred'))  + facet_wrap(~polyIC.dose.cat, ncol = 1) + coord_flip()
```

## Developmental stage at PPI testing 

```{r - developmental_stage_PPI}
developmental_stage_PPI.mag <- SMD.g %>% 
  select(effect_id, developmental_stage_PPI, magnitude_effect_size) %>% 
  mutate(magnitude_effect_size = as.factor(magnitude_effect_size)) %>% 
  group_by(developmental_stage_PPI, magnitude_effect_size) %>% 
  tally()

developmental_stage_PPI.mag.read <- developmental_stage_PPI.mag %>% pivot_wider(names_from = magnitude_effect_size, values_from = n)

developmental_stage_PPI.mag.2 <- developmental_stage_PPI.mag %>% 
  mutate(n.mag = n) %>% 
  select(-n) %>% 
  left_join(stage_PPI_effect) %>% 
  mutate(percentage = (n.mag/n)*100) %>% 
  drop_na()

developmental_stage_PPI.mag.2$magnitude_effect_size <- fct_relevel(developmental_stage_PPI.mag.2$magnitude_effect_size, 'large negative effect', 'moderate negative effect', 'small negative effect', 'no effect', 'small positive effect', 'moderate positive effect', 'large positive effect' )

ggplot(developmental_stage_PPI.mag) + 
  geom_col(aes(x = developmental_stage_PPI, y = n, fill = magnitude_effect_size)) +
  scale_fill_manual(values = c('darkblue','blue', 'lightblue', 'white', 'pink', 'red', 'darkred')) 
                                
#this would be more informative if I converted n to percentages first                             

ggplot(developmental_stage_PPI.mag.2) + 
  geom_col(aes(x = magnitude_effect_size, y = percentage, fill = magnitude_effect_size), position = 'dodge') +
  scale_fill_manual(values = c('darkblue','blue', 'lightblue', 'white', 'pink', 'red', 'darkred'))  + facet_wrap(~developmental_stage_PPI, ncol = 1) + coord_flip()
```

## GD of administration 

```{r - GD_first_administration}
GD_first_administration.mag <- SMD.g %>% 
  select(effect_id, GD_first_administration, magnitude_effect_size) %>% 
  mutate(magnitude_effect_size = as.factor(magnitude_effect_size)) %>% 
  mutate(GD_first_administration = as.factor(GD_first_administration)) %>% 
  group_by(GD_first_administration, magnitude_effect_size) %>% 
  tally()

GD_first_administration.mag.read <- GD_first_administration.mag %>% pivot_wider(names_from = magnitude_effect_size, values_from = n)
GD_administration_effect$GD_first_administration <- as.factor(GD_administration_effect$GD_first_administration)

GD_first_administration.mag.2 <- GD_first_administration.mag %>% 
  mutate(n.mag = n) %>% 
  select(-n) %>% 
  left_join(GD_administration_effect) %>% 
  mutate(percentage = (n.mag/n)*100) %>% 
  drop_na()

GD_first_administration.mag.2$magnitude_effect_size <- fct_relevel(GD_first_administration.mag.2$magnitude_effect_size, 'large negative effect', 'moderate negative effect', 'small negative effect', 'no effect', 'small positive effect', 'moderate positive effect', 'large positive effect' )

ggplot(GD_first_administration.mag) + 
  geom_col(aes(x = magnitude_effect_size, y = n, fill = magnitude_effect_size)) + 
  scale_fill_manual(values = c('darkblue','blue', 'lightblue', 'white', 'pink', 'red', 'darkred')) +
  facet_wrap( ~ GD_first_administration)
                                
#this would be more informative if I converted n to percentages first                             

ggplot(GD_first_administration.mag.2) + 
  geom_col(aes(x = magnitude_effect_size, y = percentage, fill = magnitude_effect_size), position = 'dodge') +
  scale_fill_manual(values = c('darkblue','blue', 'lightblue', 'white', 'pink', 'red', 'darkred')) + facet_wrap(~ GD_first_administration, ncol = 2) + coord_flip()
```

## Gestational stage of administration 

```{r}
stage_polyIC <- SMD.g %>% 
  select(effect_id, gestational_stage_poly) %>% 
  group_by(gestational_stage_poly) %>% 
  tally()
```

```{r - gestational_stage_poly}
gestational_stage_poly.mag <- SMD.g %>% 
  select(effect_id, gestational_stage_poly, magnitude_effect_size) %>% 
  mutate(magnitude_effect_size = as.factor(magnitude_effect_size)) %>% 
  group_by(gestational_stage_poly, magnitude_effect_size) %>% 
  tally()

gestational_stage_poly.mag.read <- gestational_stage_poly.mag %>% pivot_wider(names_from = magnitude_effect_size, values_from = n)

gestational_stage_poly.mag.2 <- gestational_stage_poly.mag %>% 
  mutate(n.mag = n) %>% 
  select(-n) %>% 
  left_join(stage_polyIC) %>% 
  mutate(percentage = (n.mag/n)*100) %>% 
  drop_na()

gestational_stage_poly.mag.2$magnitude_effect_size <- fct_relevel(gestational_stage_poly.mag.2$magnitude_effect_size, 'large negative effect', 'moderate negative effect', 'small negative effect', 'no effect', 'small positive effect', 'moderate positive effect', 'large positive effect' )

ggplot(gestational_stage_poly.mag) + 
  geom_col(aes(x = gestational_stage_poly, y = n, fill = magnitude_effect_size)) +
  scale_fill_manual(values = c('darkblue','blue', 'lightblue', 'white', 'pink', 'red', 'darkred')) 
                                
#this would be more informative if I converted n to percentages first                             

ggplot(gestational_stage_poly.mag.2) + 
  geom_col(aes(x = magnitude_effect_size, y = percentage, fill = magnitude_effect_size), position = 'dodge') +
  scale_fill_manual(values = c('darkblue','blue', 'lightblue', 'white', 'pink', 'red', 'darkred')) + facet_wrap(~ gestational_stage_poly, ncol = 1) + coord_flip()
```

could extend this to PPI testing variables 


# Characteristics of each study 


# Put some alluvium plots in here (meta-analysis_non.ind)






